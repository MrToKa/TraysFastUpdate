@page "/trays/details/{Id:int}"

@using TraysFastUpdate.Models
@using TraysFastUpdate.Services
@using TraysFastUpdate.Services.Contracts
@using Excubo.Blazor.Canvas
@inject Microsoft.JSInterop.IJSRuntime js;

@inject ITrayService TrayService
@inject ICableService CableService
@inject ISnackbar Snackbar

<PageTitle>Details</PageTitle>

<MudText Typo="Typo.h5" Class="d-flex justify-center flex-grow-1 gap-4">Tray Details</MudText>

<MudItem Class="d-flex justify-center flex-grow-1 ma-2 pa-2">
    <MudButton Href="/trays"
    Rel="nofollow"
    Variant="Variant.Filled"
    Color="Color.Primary">
        Back to List
    </MudButton>
</MudItem>

<MudPaper Elevation="0" Class="pa-1 ma-1">
    <EditForm Model="@Tray" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <MudGrid Class="d-flex justify-center flex-grow-1 gap-4 pa-1 ma-1">
            <MudItem xs="12" sm="7" Class="pa-1 ma-1" Style="@($"background: #BDBDBD;")">
                <MudText Typo="Typo.h6" Class="d-flex justify-center flex-grow-1 gap-4">Tray general information</MudText>
                <MudCard>
                    <MudCardContent>
                        <MudTextField @bind-Value="Tray.Name" For="@(() => Tray.Name)" Label="Tray Name" ReadOnly="true" />
                        <MudTextField @bind-Value="Tray.Type" For="@(() => Tray.Type)" Label="Tray Type" ReadOnly="false" />
                        <MudTextField @bind-Value="Tray.Purpose" For="@(() => Tray.Purpose)" Label="Tray Purpose" ReadOnly="false" />
                        <MudNumericField @bind-Value="Tray.Width" For="@(() => Tray.Width)" Label="Tray Width [mm]" ReadOnly="false" />
                        <MudNumericField @bind-Value="Tray.Height" For="@(() => Tray.Height)" Label="Tray Height [mm]" ReadOnly="false" />
                        <MudNumericField @bind-Value="Tray.Length" For="@(() => Tray.Length)" Label="Tray Length [mm]" ReadOnly="false" />
                        <MudNumericField @bind-Value="Tray.Weight" For="@(() => Tray.Weight)" Label="Tray Weight [kg/m]" ReadOnly="false" />
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Save changes</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudPaper>

<MudPaper Elevation="0" Class="pa-1 ma-1" Style="@($"background: #BDBDBD;")">
    <MudText Typo="Typo.h6" Class="d-flex justify-center flex-grow-1 gap-4">Cables on tray</MudText>
    @if (CablesOnTray == null || CablesOnTray.Count == 0)
    {
        <MudAlert Severity="Severity.Info">No cables found.</MudAlert>
    }
    else
    {
        <MudDataGrid T="Cable" Items="@CablesOnTray" ReadOnly="true"
        Bordered="true" Dense="true" ColumnResizeMode="ResizeMode.Column">
            <Columns>
                <TemplateColumn Title="No." CellClass="d-flex justify-center" Sortable="false" Filterable="false" Editable="false">
                    <CellTemplate>
                        @(CablesOnTray.IndexOf(context.Item) + 1)
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.Tag" Title="Cable Tag" Hideable="false" />
                <PropertyColumn Property="x => x.CableType.Type" Title="Cable Type" Hideable="false" />
                <PropertyColumn Property="x => x.CableType.Diameter" Title="Cable Diameter [mm]" Hideable="false" />
                <PropertyColumn Property="x => x.CableType.Weight" Title="Cable Weight [kg/m]" Hideable="false" />
            </Columns>
            <PagerContent>
                <MudDataGridPager PageSizeOptions="[15, 25, 50]" T="Cable" />
            </PagerContent>
        </MudDataGrid>
    }
</MudPaper>

<MudPaper>
    <MudGrid Class="d-flex justify-center flex-grow-1 gap-4 pa-1 ma-1">
        <MudItem xs="12" sm="7" Class="pa-1 ma-1" Style="@($"background: #BDBDBD;")">
            <MudText Typo="Typo.h6" Class="d-flex justify-center flex-grow-1 gap-4">Tray Weight Calculations</MudText>
            <MudCard>
                <MudCardContent>
                    <MudTextField @bind-Value="Tray.SupportsCount" For="@(() => Tray.SupportsCount)" Label="Supports count" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.SupportsTotalWeight" For="@(() => Tray.SupportsTotalWeight)" Label="Total Supports Weight [kg]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.SupportsWeightLoadPerMeter" For="@(() => Tray.SupportsWeightLoadPerMeter)" Label="Supports weight load per meter [kg/m]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.TrayWeightLoadPerMeter" For="@(() => Tray.TrayWeightLoadPerMeter)" Label="Tray weight load per meter [kg/m]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.TrayOwnWeightLoad" For="@(() => Tray.TotalWeightLoad)" Label="Tray total own weight [kg]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.CablesWeightPerMeter" For="@(() => Tray.CablesWeightPerMeter)" Label="Cables weight load per meter [kg/m]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.CablesWeightLoad" For="@(() => Tray.CablesWeightLoad)" Label="Cables total weight on the tray [kg]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.TotalWeightLoadPerMeter" For="@(() => Tray.TotalWeightLoadPerMeter)" Label="Total tray weight load per meter [kg/m]" ReadOnly="true" />
                    <MudTextField @bind-Value="Tray.TotalWeightLoad" For="@(() => Tray.TotalWeightLoad)" Label="Total tray weight [kg]" ReadOnly="true" />
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper>
    <MudItem Class="pa-1 ma-1">
        <Canvas @ref="canvas" width="@CanvasWidth" height="@CanvasHeight" style="border: 1px solid black" />
    </MudItem>
</MudPaper>

@code {
    [Parameter]
    public int Id { get; set; }

    private Tray Tray { get; set; } = new Tray();

    private List<Cable> CablesOnTray = new List<Cable>();

    private Canvas canvas = new Canvas();

    private int canvasScale = 3;

    private double CanvasWidth => ((Tray.Width) * canvasScale) + 100;
    private double CanvasHeight => ((Tray.Height) * canvasScale) + 100;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await DrawTray();
        }
    }

    private async Task HandleTrayPropertyChange()
    {
        await InvokeAsync(StateHasChanged);
        await DrawTray();
    }

    protected override async Task OnInitializedAsync()
    {
        Tray = await TrayService.GetTrayAsync(Id);
        await TrayService.UpdateTrayAsync(Tray);
        CablesOnTray = await CableService.GetCablesOnTrayAsync(Tray);
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            await TrayService.UpdateTrayAsync(Tray);
            Snackbar.Add("Tray details updated successfully!", Severity.Success);
            await HandleTrayPropertyChange();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating tray details: {ex.Message}", Severity.Error);
        }
    }

    private async Task DrawTray()
    {
        try
        {
            await using (var ctx = await canvas.GetContext2DAsync())
            {
                const int textPadding = 20;
                const int CProfileHeight = 15;

                await ctx.RestoreAsync();
                await ctx.TranslateAsync(-textPadding, -(50 + Tray.Height * canvasScale / 2));
                await ctx.ClearRectAsync(0, 0, CanvasWidth, CanvasHeight);

                // Add title text above the rectangle
                await ctx.SetTransformAsync(1, 0, 0, 1, 0, 0);

                await ctx.SaveAsync();
                await ctx.FontAsync("24px Arial");
                await ctx.FillStyleAsync("black");
                await ctx.TextAlignAsync(TextAlign.Center);
                await ctx.TextBaseLineAsync(TextBaseLine.Middle);
                await ctx.FillTextAsync($"Cables bundles laying concept for tray {Tray.Name}", Tray.Width * canvasScale / 2, 30);
                await ctx.RestoreAsync();

                //Height at the left side
                await ctx.SaveAsync();
                await ctx.FontAsync("24px Arial");
                await ctx.FillStyleAsync("black");
                await ctx.TextAlignAsync(TextAlign.Center);
                await ctx.TextBaseLineAsync(TextBaseLine.Middle);
                await ctx.TranslateAsync(textPadding, 50 + Tray.Height * canvasScale / 2);
                await ctx.RotateAsync(Math.PI / 2);
                await ctx.FillTextAsync($"Useful tray height: {Tray.Height - CProfileHeight} mm", 0, 0);
                await ctx.RestoreAsync();

                // Draw rectangle
                await ctx.StrokeStyleAsync("black");
                await ctx.StrokeRectAsync(50, 50, Tray.Width * canvasScale, (Tray.Height - CProfileHeight) * canvasScale);
                //Draw C-profile
                await ctx.StrokeStyleAsync("black");
                await ctx.StrokeRectAsync(50, 50 + (Tray.Height - CProfileHeight) * canvasScale, Tray.Width * canvasScale, CProfileHeight * canvasScale);
                //fill C-profile
                await ctx.FillStyleAsync("#D3D3D3");
                await ctx.FillRectAsync(50, 50 + (Tray.Height - CProfileHeight) * canvasScale, Tray.Width * canvasScale, CProfileHeight * canvasScale);

                // Width at the bottom
                await ctx.FontAsync("24px Arial");
                await ctx.FillStyleAsync("black");
                await ctx.TextAlignAsync(TextAlign.Center);
                await ctx.TextBaseLineAsync(TextBaseLine.Middle);
                await ctx.FillTextAsync($"Useful tray width: {(Tray.Width)} mm", (Tray.Width * canvasScale) / 2, 50 + (Tray.Height * canvasScale) + textPadding);

                await ctx.SetTransformAsync(1, 0, 0, 1, 0, 0);
                double spacing = 1 * canvasScale; // Adjust spacing as needed

                double leftStartX = 50 + spacing;
                double rightStartX = 50 + Tray.Width * canvasScale - spacing;
                double bottomStartY = 50 + (Tray.Height - CProfileHeight) * canvasScale - spacing;
                int cableNumber = 1;

                foreach (var cable in CablesOnTray)
                {
                    double radius = cable.CableType.Diameter / 2 * canvasScale;
                    await ctx.BeginPathAsync();
                    await ctx.ArcAsync(leftStartX + radius, bottomStartY - radius, radius, 0, Math.PI * 2);
                    await ctx.ClosePathAsync();
                    await ctx.StrokeAsync();
                    // Draw cable number inside the circle
                    await ctx.FontAsync("12px Arial");
                    await ctx.FillStyleAsync("black");
                    await ctx.TextAlignAsync(TextAlign.Center);
                    await ctx.TextBaseLineAsync(TextBaseLine.Middle);
                    await ctx.FillTextAsync(cableNumber.ToString(), leftStartX + radius, bottomStartY - radius);

                    leftStartX += cable.CableType.Diameter * canvasScale + spacing;
                    cableNumber++;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during canvas drawing: {ex.Message}");
        }
    }
}
